import React, { useRef, useState } from "react";
import {
  View,
  Text,
  StyleSheet,
  Pressable,
  TextInput,
} from "react-native";
import Canvas from "react-native-canvas";
import * as ImagePicker from "expo-image-picker";

export default function App() {

  const [screen, setScreen] = useState("home");
  const [elements, setElements] = useState([]);
  const [selected, setSelected] = useState(null);

  const canvasRef = useRef(null);

  /* ===== DRAW ===== */
  const draw = (canvas) => {
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    elements.forEach(el => {
      if (el.type === "text") {
        ctx.fillStyle = el.color;
        ctx.font = `${el.size}px Arial`;
        ctx.fillText(el.text, el.x, el.y);
      }

      if (el.type === "image" && el.img) {
        ctx.drawImage(el.img, el.x, el.y, el.w, el.h);
      }
    });
  };

  /* ===== ADD TEXT ===== */
  const addText = () => {
    setElements([
      ...elements,
      {
        type: "text",
        text: "Design 5G",
        x: 120,
        y: 200,
        size: 40,
        color: "#000"
      }
    ]);
  };

  /* ===== ADD IMAGE ===== */
  const addImage = async () => {
    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images
    });

    if (!result.canceled) {
      const img = new Image();
      img.src = result.assets[0].uri;

      setElements([
        ...elements,
        {
          type: "image",
          img,
          x: 100,
          y: 100,
          w: 150,
          h: 150
        }
      ]);
    }
  };

  /* ===== COLOR ===== */
  const changeColor = (color) => {
    if (!selected) return;
    selected.color = color;
    setElements([...elements]);
  };

  /* ===== SIZE ===== */
  const changeSize = (size) => {
    if (!selected) return;
    selected.size = size;
    setElements([...elements]);
  };

  /* ===== HOME ===== */
  if (screen === "home") {
    return (
      <View style={styles.home}>
        <Text style={styles.title}>ðŸ”¥ Design 5G</Text>

        <View style={styles.grid}>
          <Pressable style={styles.card}
            onPress={() => setScreen("editor")}>
            <Text>Instagram Post</Text>
          </Pressable>

          <Pressable style={styles.card}
            onPress={() => setScreen("editor")}>
            <Text>Poster</Text>
          </Pressable>
        </View>
      </View>
    );
  }

  /* ===== EDITOR ===== */
  return (
    <View style={styles.editor}>

      {/* TOOLS */}
      <View style={styles.tools}>
        <Pressable style={styles.tool} onPress={addText}>
          <Text>Texte</Text>
        </Pressable>

        <Pressable style={styles.tool} onPress={addImage}>
          <Text>Image</Text>
        </Pressable>
      </View>

      {/* CANVAS */}
      <View style={styles.canvasArea}>
        <Canvas
          ref={canvas => {
            canvasRef.current = canvas;
            draw(canvas);
          }}
          style={{ width: 400, height: 400 }}
        />
      </View>

      {/* CONTROLS */}
      <View style={styles.controls}>
        <TextInput
          placeholder="#000000"
          style={styles.input}
          onSubmitEditing={(e)=>changeColor(e.nativeEvent.text)}
        />

        <TextInput
          placeholder="Taille"
          style={styles.input}
          keyboardType="numeric"
          onSubmitEditing={(e)=>changeSize(Number(e.nativeEvent.text))}
        />
      </View>

    </View>
  );
}

const styles = StyleSheet.create({
  home:{
    flex:1,
    padding:20,
    alignItems:"center",
    justifyContent:"center",
    backgroundColor:"#f3f4f6"
  },

  title:{
    fontSize:28,
    fontWeight:"bold"
  },

  grid:{
    flexDirection:"row",
    marginTop:20,
    gap:15
  },

  card:{
    backgroundColor:"#fff",
    padding:20,
    borderRadius:15,
    elevation:4
  },

  editor:{ flex:1 },

  tools:{
    position:"absolute",
    left:0,
    top:0,
    bottom:0,
    width:80,
    backgroundColor:"#111",
    padding:10
  },

  tool:{
    backgroundColor:"#fff",
    padding:10,
    borderRadius:12,
    marginVertical:10,
    alignItems:"center"
  },

  canvasArea:{
    flex:1,
    marginLeft:90,
    justifyContent:"center",
    alignItems:"center"
  },

  controls:{
    position:"absolute",
    bottom:0,
    left:90,
    right:0,
    backgroundColor:"#fff",
    flexDirection:"row",
    padding:10,
    gap:10
  },

  input:{
    borderWidth:1,
    padding:8,
    width:100,
    borderRadius:8
  }
});
