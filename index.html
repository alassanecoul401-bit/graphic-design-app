<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
let selected=null;
let zoom=1;
const canvas=document.getElementById("canvas");

// ======================
// SAUVEGARDE AUTOMATIQUE
// ======================
function saveDesign(){
localStorage.setItem("design",canvas.innerHTML);
}

function loadDesign(){
let data=localStorage.getItem("design");
if(data){
canvas.innerHTML=data;
restoreEvents();
}
}

window.onload=loadDesign;

// ======================
// MODELES (TEMPLATES)
// ======================
function templatePoster(){
canvas.innerHTML="";
addTextCustom("MON ÉVÉNEMENT",300,80,"40px","#111");
addTextCustom("Bienvenue à tous",320,200,"22px","#555");
saveDesign();
}

function templateInstagram(){
canvas.innerHTML="";
canvas.style.width="600px";
canvas.style.height="600px";
addTextCustom("Promo -50%",180,250,"45px","red");
saveDesign();
}

// ======================
// TEXTE
// ======================
function addText(){
addTextCustom("Double clique pour modifier",50,50,"20px","#000");
}

function addTextCustom(text,x,y,size,color){
let el=document.createElement("div");
el.className="element";
el.innerText=text;
el.contentEditable=true;
el.style.left=x+"px";
el.style.top=y+"px";
el.style.fontSize=size;
el.style.color=color;

addResize(el);
addEvents(el);
canvas.appendChild(el);
saveDesign();
}

// ======================
// IMAGE
// ======================
function addImage(e){
let file=e.target.files[0];
let img=document.createElement("img");
img.src=URL.createObjectURL(file);
img.className="element";
img.style.width="150px";
img.style.left="80px";
img.style.top="80px";

addResize(img);
addEvents(img);
canvas.appendChild(img);
saveDesign();
}

// ======================
// EVENTS
// ======================
function addEvents(el){
el.onclick=(ev)=>{
ev.stopPropagation();
select(el);
};

let offsetX,offsetY,isDown=false;

el.onmousedown=(e)=>{
if(e.target.classList.contains("resize")) return;
isDown=true;
offsetX=e.offsetX;
offsetY=e.offsetY;
};

document.onmouseup=()=>isDown=false;

document.onmousemove=(e)=>{
if(!isDown || selected!==el) return;
el.style.left=(e.pageX-canvas.offsetLeft-offsetX)+"px";
el.style.top=(e.pageY-canvas.offsetTop-offsetY)+"px";
saveDesign();
};
}

// ======================
// RESIZE
// ======================
function addResize(el){
let box=document.createElement("div");
box.className="resize";
el.appendChild(box);

let resizing=false;

box.onmousedown=(e)=>{
e.stopPropagation();
resizing=true;
};

document.onmouseup=()=>resizing=false;

document.onmousemove=(e)=>{
if(!resizing || selected!==el) return;
el.style.width=e.pageX-el.offsetLeft+"px";
saveDesign();
};
}

// ======================
function restoreEvents(){
document.querySelectorAll(".element").forEach(el=>{
addResize(el);
addEvents(el);
});
}

// ======================
function select(el){
document.querySelectorAll(".element").forEach(e=>e.classList.remove("selected"));
selected=el;
el.classList.add("selected");
}

function deleteElement(){
if(selected){
selected.remove();
selected=null;
saveDesign();
}
}

// ======================
function changeFont(){
if(selected){
selected.style.fontFamily=document.getElementById("fontSelect").value;
saveDesign();
}
}

function changeColor(color){
if(selected){
selected.style.color=color;
saveDesign();
}
}

// ======================
function zoomIn(){
zoom+=0.1;
canvas.style.transform="scale("+zoom+")";
}

function zoomOut(){
zoom-=0.1;
canvas.style.transform="scale("+zoom+")";
}

// ======================
function downloadImage(){
html2canvas(canvas).then(c=>{
let link=document.createElement("a");
link.download="design.png";
link.href=c.toDataURL();
link.click();
});
}

canvas.onclick=()=>{
document.querySelectorAll(".element").forEach(e=>e.classList.remove("selected"));
selected=null;
}
</script>
